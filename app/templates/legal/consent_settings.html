{% extends "base.html" %}

{% block title %}{{ _('legal.consent_management') }} - {{ _('site.name') }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="bg-white rounded-lg shadow-lg p-8">
        <!-- Header -->
        <div class="border-b border-gray-200 pb-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                {{ _('legal.consent_management') }}
            </h1>
            <p class="text-gray-600">
                {{ _('legal.consent_management_description') }}
            </p>
        </div>

        <!-- Current Consent Status -->
        {% if current_consent %}
        <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-8">
            <h3 class="text-lg font-medium text-green-900 mb-4">
                {{ _('legal.current_consent_status') }}
            </h3>
            <div class="grid md:grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="text-green-700">{{ _('legal.consent_given') }}: {{ current_consent.given_at | strftime('%d.%m.%Y %H:%M') }}</span>
                </div>
                <div>
                    <span class="text-green-700">{{ _('legal.consent_expires') }}: {{ current_consent.expires_at | strftime('%d.%m.%Y') }}</span>
                </div>
                <div>
                    <span class="text-green-700">{{ _('legal.consent_version') }}: {{ current_consent.version }}</span>
                </div>
                <div>
                    <span class="text-green-700">{{ _('legal.consent_language') }}: {{ _('languages.' + current_consent.language) }}</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Consent Form -->
        <form id="consent-form" method="POST" action="{{ url_for('legal.update_consent') }}">
            <input type="hidden" name="language" value="{{ language }}">
            <input type="hidden" name="version" value="1.0">
            
            <!-- Necessary Cookies (Always Enabled) -->
            <div class="mb-8">
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <input type="checkbox" 
                                   checked 
                                   disabled 
                                   class="h-4 w-4 text-gray-400 rounded border-gray-300">
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="text-lg font-medium text-gray-900">
                                {{ _('legal.necessary_cookies') }}
                                <span class="text-sm text-gray-500 font-normal">({{ _('legal.always_active') }})</span>
                            </h4>
                            <p class="text-gray-600 mt-2">
                                {{ _('legal.necessary_cookies_description') }}
                            </p>
                            <div class="mt-3 text-sm text-gray-500">
                                <strong>{{ _('legal.data_processed') }}:</strong> 
                                {{ _('legal.necessary_data_list') }}
                            </div>
                            <div class="mt-2 text-sm text-gray-500">
                                <strong>{{ _('legal.legal_basis') }}:</strong> 
                                {{ _('legal.necessary_legal_basis') }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Functional Cookies -->
            <div class="mb-8">
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <input type="checkbox" 
                                   name="functional" 
                                   value="true"
                                   {% if current_consent and current_consent.functional %}checked{% endif %}
                                   class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="text-lg font-medium text-gray-900">
                                {{ _('legal.functional_cookies') }}
                            </h4>
                            <p class="text-gray-600 mt-2">
                                {{ _('legal.functional_cookies_description') }}
                            </p>
                            <div class="mt-3 text-sm text-gray-500">
                                <strong>{{ _('legal.data_processed') }}:</strong> 
                                {{ _('legal.functional_data_list') }}
                            </div>
                            <div class="mt-2 text-sm text-gray-500">
                                <strong>{{ _('legal.retention_period') }}:</strong> 
                                {{ _('legal.functional_retention') }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Cookies -->
            <div class="mb-8">
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <input type="checkbox" 
                                   name="analytics" 
                                   value="true"
                                   {% if current_consent and current_consent.analytics %}checked{% endif %}
                                   class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="text-lg font-medium text-gray-900">
                                {{ _('legal.analytics_cookies') }}
                            </h4>
                            <p class="text-gray-600 mt-2">
                                {{ _('legal.analytics_cookies_description') }}
                            </p>
                            <div class="mt-3 text-sm text-gray-500">
                                <strong>{{ _('legal.data_processed') }}:</strong> 
                                {{ _('legal.analytics_data_list') }}
                            </div>
                            <div class="mt-2 text-sm text-gray-500">
                                <strong>{{ _('legal.third_parties') }}:</strong> 
                                {{ _('legal.analytics_third_parties') }}
                            </div>
                            <div class="mt-2 text-sm text-gray-500">
                                <strong>{{ _('legal.retention_period') }}:</strong> 
                                {{ _('legal.analytics_retention') }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marketing Cookies -->
            <div class="mb-8">
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <input type="checkbox" 
                                   name="marketing" 
                                   value="true"
                                   {% if current_consent and current_consent.marketing %}checked{% endif %}
                                   class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="text-lg font-medium text-gray-900">
                                {{ _('legal.marketing_cookies') }}
                            </h4>
                            <p class="text-gray-600 mt-2">
                                {{ _('legal.marketing_cookies_description') }}
                            </p>
                            <div class="mt-3 text-sm text-gray-500">
                                <strong>{{ _('legal.data_processed') }}:</strong> 
                                {{ _('legal.marketing_data_list') }}
                            </div>
                            <div class="mt-2 text-sm text-gray-500">
                                <strong>{{ _('legal.third_parties') }}:</strong> 
                                {{ _('legal.marketing_third_parties') }}
                            </div>
                            <div class="mt-2 text-sm text-gray-500">
                                <strong>{{ _('legal.retention_period') }}:</strong> 
                                {{ _('legal.marketing_retention') }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical Disclaimer -->
            <div class="mb-8">
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <input type="checkbox" 
                                   name="medical_disclaimer" 
                                   value="true"
                                   {% if current_consent and current_consent.medical_disclaimer %}checked{% endif %}
                                   class="h-4 w-4 text-red-600 rounded border-gray-300 focus:ring-red-500">
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="text-lg font-medium text-gray-900">
                                {{ _('legal.medical_disclaimer_consent') }}
                            </h4>
                            <p class="text-gray-600 mt-2">
                                {{ _('legal.medical_disclaimer_description') }}
                            </p>
                            <div class="mt-3 text-sm text-red-600 bg-red-50 p-3 rounded">
                                <strong>{{ _('legal.important') }}:</strong> 
                                {{ _('legal.medical_disclaimer_important') }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex flex-wrap gap-4 pt-6 border-t border-gray-200">
                <button type="submit" 
                        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    {{ _('legal.save_preferences') }}
                </button>
                
                <button type="button" 
                        onclick="selectAll(true)"
                        class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                    {{ _('legal.accept_all') }}
                </button>
                
                <button type="button" 
                        onclick="selectAll(false)"
                        class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors">
                    {{ _('legal.reject_optional') }}
                </button>
                
                {% if current_consent %}
                <button type="button" 
                        onclick="withdrawConsent()"
                        class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors ml-auto">
                    {{ _('legal.withdraw_all_consent') }}
                </button>
                {% endif %}
            </div>
        </form>

        <!-- Legal Information -->
        <div class="mt-12 bg-blue-50 border-l-4 border-blue-500 p-6">
            <h4 class="font-medium text-blue-900 mb-2">
                {{ _('legal.your_rights') }}
            </h4>
            <div class="text-sm text-blue-800 space-y-2">
                <p>{{ _('legal.consent_rights_description') }}</p>
                <ul class="list-disc list-inside mt-2 space-y-1">
                    <li>{{ _('legal.right_withdraw_anytime') }}</li>
                    <li>{{ _('legal.right_object_processing') }}</li>
                    <li>{{ _('legal.right_access_data') }}</li>
                    <li>{{ _('legal.right_rectify_data') }}</li>
                    <li>{{ _('legal.right_erase_data') }}</li>
                    <li>{{ _('legal.right_data_portability') }}</li>
                </ul>
            </div>
            
            <div class="mt-4 flex flex-wrap gap-3">
                <a href="{{ url_for('legal.data_request_form') }}" 
                   class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors text-sm">
                    {{ _('legal.submit_data_request') }}
                </a>
                <a href="{{ url_for('legal.privacy_policy') }}" 
                   class="bg-blue-100 text-blue-800 px-4 py-2 rounded hover:bg-blue-200 transition-colors text-sm">
                    {{ _('legal.read_privacy_policy') }}
                </a>
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <a href="{{ url_for('public.home') }}" 
               class="text-blue-600 hover:text-blue-800 transition-colors">
                ← {{ _('navigation.back_to_home') }}
            </a>
        </div>
    </div>
</div>

<!-- JavaScript for Consent Management -->
<script>
function selectAll(accept) {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:not([disabled])');
    checkboxes.forEach(checkbox => {
        checkbox.checked = accept;
    });
}

function withdrawConsent() {
    if (confirm('{{ _("legal.confirm_withdraw_consent") }}')) {
        fetch('{{ url_for("legal.withdraw_consent") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                types: ['functional', 'analytics', 'marketing']
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{{ _("legal.consent_withdrawn_success") }}');
                location.reload();
            } else {
                alert('{{ _("legal.consent_withdrawal_failed") }}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{{ _("legal.consent_withdrawal_failed") }}');
        });
    }
}

// Form submission with AJAX
document.getElementById('consent-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    fetch(this.action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('{{ _("legal.consent_updated_success") }}');
            location.reload();
        } else {
            alert('{{ _("legal.consent_update_failed") }}');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{{ _("legal.consent_update_failed") }}');
    });
});
</script>
{% endblock %}