{% extends "admin/base.html" %}

{% block title %}Besucher-Statistiken{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">üìä Besucher-Statistiken</h1>
        <p class="mt-2 text-gray-600">√úbersicht der Hauptseiten-Besuche und QR-Code-Nutzung</p>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-users text-blue-600 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Gesamtbesuche (30 Tage)</dt>
                            <dd class="text-lg font-medium text-gray-900" id="total-visits">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-qrcode text-green-600 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">QR-Code Scans</dt>
                            <dd class="text-lg font-medium text-gray-900" id="qr-scans">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-mobile-alt text-purple-600 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Mobile Besuche</dt>
                            <dd class="text-lg font-medium text-gray-900" id="mobile-percentage">0%</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-language text-orange-600 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Thai-sprachige Besucher</dt>
                            <dd class="text-lg font-medium text-gray-900" id="thai-percentage">0%</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Detailed Data -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Daily Visits Chart -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">T√§gliche Besuche (letzte 14 Tage)</h3>
                <div class="h-64">
                    <canvas id="daily-visits-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Popular Times -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Beliebte Besuchszeiten</h3>
                <div class="h-64">
                    <canvas id="hourly-visits-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Device Breakdown -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Ger√§te-Verteilung</h3>
                <div class="space-y-3" id="device-breakdown">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Language Breakdown -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Sprachen-Verteilung</h3>
                <div class="space-y-3" id="language-breakdown">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="mt-8 bg-white overflow-hidden shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Letzte Aktivit√§t</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="recent-activity-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Zeit</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Seite</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ger√§t</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sprache</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QR-Code</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="activity-tbody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Privacy Notice -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-600"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">Datenschutz-Hinweis</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <p>
                        Alle Analytics-Daten werden anonymisiert erfasst. IP-Adressen werden nicht gespeichert, 
                        nur anonymisierte Session-Hashes. Tracking erfolgt nur mit Einwilligung der Besucher 
                        gem√§√ü PDPA Thailand und DSGVO.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let dailyChart, hourlyChart;

// Initialize analytics dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsSummary();
    loadDailyStats();
    loadPopularTimes();
    loadRecentActivity();
    
    // Auto-refresh every 5 minutes
    setInterval(() => {
        loadAnalyticsSummary();
        loadRecentActivity();
    }, 5 * 60 * 1000);
});

async function loadAnalyticsSummary() {
    try {
        const response = await fetch('/admin/api/analytics/summary');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.stats;
            document.getElementById('total-visits').textContent = stats.total_visits || 0;
            document.getElementById('qr-scans').textContent = stats.qr_scans || 0;
            document.getElementById('mobile-percentage').textContent = stats.mobile_percentage + '%';
            document.getElementById('thai-percentage').textContent = stats.thai_percentage + '%';
            
            // Update device breakdown
            updateDeviceBreakdown(data.device_stats || {});
            updateLanguageBreakdown(data.language_stats || {});
        }
    } catch (error) {
        console.error('Error loading analytics summary:', error);
    }
}

async function loadDailyStats() {
    try {
        const response = await fetch('/admin/api/analytics/daily?days=14');
        const data = await response.json();
        
        if (data.success) {
            updateDailyChart(data.stats);
        }
    } catch (error) {
        console.error('Error loading daily stats:', error);
    }
}

async function loadPopularTimes() {
    try {
        const response = await fetch('/admin/api/analytics/popular-times?days=7');
        const data = await response.json();
        
        if (data.success) {
            updateHourlyChart(data.stats);
        }
    } catch (error) {
        console.error('Error loading popular times:', error);
    }
}

async function loadRecentActivity() {
    try {
        const response = await fetch('/admin/api/analytics/recent-activity?limit=20');
        const data = await response.json();
        
        if (data.success) {
            updateRecentActivityTable(data.activity);
        }
    } catch (error) {
        console.error('Error loading recent activity:', error);
    }
}

function updateDailyChart(stats) {
    const ctx = document.getElementById('daily-visits-chart').getContext('2d');
    
    if (dailyChart) {
        dailyChart.destroy();
    }
    
    dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: stats.map(s => new Date(s.date).toLocaleDateString('de-DE')),
            datasets: [{
                label: 'Besuche',
                data: stats.map(s => s.total_visits),
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.3
            }, {
                label: 'QR-Scans',
                data: stats.map(s => s.qr_scans),
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateHourlyChart(stats) {
    const ctx = document.getElementById('hourly-visits-chart').getContext('2d');
    
    if (hourlyChart) {
        hourlyChart.destroy();
    }
    
    const hourlyData = [];
    for (let hour = 0; hour < 24; hour++) {
        hourlyData.push(stats.hourly_visits[hour] || 0);
    }
    
    hourlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Besuche',
                data: hourlyData,
                backgroundColor: 'rgba(139, 92, 246, 0.6)',
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateDeviceBreakdown(deviceStats) {
    const container = document.getElementById('device-breakdown');
    const total = (deviceStats.mobile || 0) + (deviceStats.tablet || 0) + (deviceStats.desktop || 0);
    
    if (total === 0) {
        container.innerHTML = '<p class="text-gray-500">Keine Daten verf√ºgbar</p>';
        return;
    }
    
    const devices = [
        { name: 'Mobile', count: deviceStats.mobile || 0, color: 'bg-blue-500' },
        { name: 'Tablet', count: deviceStats.tablet || 0, color: 'bg-green-500' },
        { name: 'Desktop', count: deviceStats.desktop || 0, color: 'bg-purple-500' }
    ];
    
    container.innerHTML = devices.map(device => {
        const percentage = Math.round((device.count / total) * 100);
        return `
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-3 h-3 ${device.color} rounded-full mr-2"></div>
                    <span class="text-sm text-gray-700">${device.name}</span>
                </div>
                <div class="flex items-center">
                    <span class="text-sm text-gray-900 mr-2">${device.count}</span>
                    <span class="text-sm text-gray-500">(${percentage}%)</span>
                </div>
            </div>
        `;
    }).join('');
}

function updateLanguageBreakdown(languageStats) {
    const container = document.getElementById('language-breakdown');
    const total = (languageStats.thai || 0) + (languageStats.english || 0) + (languageStats.german || 0);
    
    if (total === 0) {
        container.innerHTML = '<p class="text-gray-500">Keine Daten verf√ºgbar</p>';
        return;
    }
    
    const languages = [
        { name: '‡πÑ‡∏ó‡∏¢ (Thai)', count: languageStats.thai || 0, color: 'bg-red-500', flag: 'üáπüá≠' },
        { name: 'English', count: languageStats.english || 0, color: 'bg-blue-500', flag: 'üá¨üáß' },
        { name: 'Deutsch', count: languageStats.german || 0, color: 'bg-yellow-500', flag: 'üá©üá™' }
    ];
    
    container.innerHTML = languages.map(lang => {
        const percentage = Math.round((lang.count / total) * 100);
        return `
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="mr-2">${lang.flag}</span>
                    <span class="text-sm text-gray-700">${lang.name}</span>
                </div>
                <div class="flex items-center">
                    <span class="text-sm text-gray-900 mr-2">${lang.count}</span>
                    <span class="text-sm text-gray-500">(${percentage}%)</span>
                </div>
            </div>
        `;
    }).join('');
}

function updateRecentActivityTable(activities) {
    const tbody = document.getElementById('activity-tbody');
    
    if (!activities || activities.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                    Keine Aktivit√§t in den letzten Stunden
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = activities.map(activity => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${new Date(activity.visit_time).toLocaleString('de-DE')}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${activity.page_path}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <span class="inline-flex items-center">
                    <i class="fas fa-${getDeviceIcon(activity.device_type)} mr-1"></i>
                    ${activity.device_type || 'unbekannt'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${getLanguageFlag(activity.preferred_language)} ${activity.preferred_language}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                ${activity.qr_code_scan ? 
                    '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">QR</span>' : 
                    '<span class="text-gray-400">-</span>'
                }
            </td>
        </tr>
    `).join('');
}

function getDeviceIcon(deviceType) {
    switch (deviceType) {
        case 'mobile': return 'mobile-alt';
        case 'tablet': return 'tablet-alt';
        case 'desktop': return 'desktop';
        default: return 'question';
    }
}

function getLanguageFlag(lang) {
    switch (lang) {
        case 'th': return 'üáπüá≠';
        case 'en': return 'üá¨üáß';
        case 'de': return 'üá©üá™';
        default: return 'üåê';
    }
}
</script>
{% endblock %}